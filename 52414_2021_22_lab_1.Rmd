---
title: "52414 - lab 1 Solutions"
author: "Halit Cohen and Yoray Mauda"
date: "25/4/2022"
output: html_document
---


```{r, include=FALSE}
library(tidyverse) # This includes dplyr, stringr, ggplot2, ..
library(dplyr)
library(data.table)
library(rworldmap) # world map
library(ggthemes)
library(reshape2) # melt: change data-frame format long/wide
library(e1071) # skewness and kurtosis
library(RColorBrewer)

```  

**Solution:**  

1. In this section, we will load the data frame, and will compute basic processing. Plus, we will list a table the top five dates as requested. 
```{r} 

# a. Loading the data:
df <- read.csv("https://raw.githubusercontent.com/DataScienceHU/r52414_2021_22_lab1-Mauda_Yoray_and_Cohen_Halit/main/owid-covid-data.csv")

# Modifying date because its in "character" class.
df$date <- as.Date(df$date,origin = "%Y-%m-%d")
class(df$date)
# b. Listing five top dates
High_income_new_cases <- filter(df,location == "High income")%>%
arrange(desc(new_cases))
top_n(High_income_new_cases[c("date","new_cases")],5)

High_income_new_deaths <- filter(df,location == "High income")%>%
  arrange(desc(new_deaths))
top_n(High_income_new_cases[c("date","new_deaths")],5)

High_income_new_vaccinations <- filter(df,location == "High income")%>%
  arrange(desc(new_vaccinations))
top_n(High_income_new_cases[c("date","new_vaccinations")],5)

```
[Solution text - description of analysis and results]


2. In this Question, we will compute a function that plots high and low income in one graph, as a function of date. 
```{r}
# a. Here we create the function
#להתייחס עריכם חסרין ולכתוב הסבר
function_question2 <- function(data_frame, col_name)
{
  filtered_covid_data_high <- data_frame %>% filter(location == "High income")
  filtered_covid_data_low <- data_frame %>% filter(location == "Low income")
  ggplot(filtered_covid_data_high, aes(date, {{col_name}})) + geom_point() +
    geom_point(data = filtered_covid_data_low, colour = "red")
}
# b. In this sub-question, we create four more plots based on demand
plot_1 <- function_question2(df,new_cases_per_million)
plot_1
plot_2 <- function_question2(df,new_cases_smoothed_per_million)
plot_2
plot_3 <- function_question2(df,new_deaths_smoothed)
plot_3
plot_4 <- function_question2(df,new_vaccinations_smoothed)
plot_4

```
[Solution text - description of analysis and results]

3. [Solution text - explanations] 
```{r} 
"a"
#Filter, compare and update the information to get the latest
df_c<-df%>%fill(c("continent","total_cases_per_million","total_vaccinations_per_hundred","people_fully_vaccinated_per_hundred","total_boosters_per_hundred","excess_mortality_cumulative_per_million","total_deaths_per_million","date"), .direction = 'down')
current <-df_c[c("location","continent","total_cases_per_million","total_vaccinations_per_hundred","people_fully_vaccinated_per_hundred","total_boosters_per_hundred","excess_mortality_cumulative_per_million","total_deaths_per_million","date")] %>%group_by(location)%>%slice(which.max(date))

"b"
#create a plot and Computers of skewness and kurtosis
"Does this histogram look close to the normal distribution? Compute the skewness and kurtosis for this distribution, and explain what they mean about the empirical distribution of the data.???"
"צריך להוסיף פה הסבר על הגרף"
ggplot(current, aes(x=total_deaths_per_million))+geom_histogram(bins = 30)+labs(x="total deaths per million", y="Frequency")
tdpm <- current$total_deaths_per_million
tdpm[tdpm == ""]<-NA
tdpm_1<-na.omit(tdpm)
skewness<-skewness(tdpm_1)
kurtosis<-kurtosis(tdpm_1)
skewness
kurtosis

"c"
"What is the slope and what does it represent???"
#Create a linear regression
ggplot(current,aes( x=total_cases_per_million, y=total_deaths_per_million))+geom_point()+
   geom_smooth(method=lm,se=FALSE)
lm(current$total_deaths_per_million~current$total_cases_per_million)

```
[Solution text - description of analysis and results]

4. [Solution text - explanations] 
```{r} 
"לאחר התסכלות שטחית על המידע ניתן לראות קטגוריית היבשות אינה מוזנת באוםן נכון וחלק מפרטיה נמתאים בשדה מירום ולכן נבצע קודם סידור של הנתונים"
"Find two outlier countries (can be of any continent) and write their name and value."
"a"
#Organize the data
current_q4 <- current[c("continent","total_vaccinations_per_hundred")]
current_q4[current_q4 ==""]<- NA
current_q4 <-na.omit(current_q4)
#creat a plot
ggplot(current_q4, aes(x = continent, y = total_vaccinations_per_hundred,fill=continent)) + geom_boxplot()


"b"
"and describe the results???"
#Add a new field and group the data into groups
df_q4 <- df%>%group_by(location)%>%mutate(booster_ratio=total_boosters/people_fully_vaccinated)
df_q4<-subset(df_q4,location %in% c('Africa', 'Asia', 'Europe', 'North America', 'Oceania', 'South America'))
ggplot(df_q4,aes(x=date,y=booster_ratio,color=location))+geom_line()+labs(title = "booster ratio and continent",x="Date", y="booster_ratio")

```
[Solution text - description of analysis and results]

5. [Solution text - explanations] 
```{r} 
# Solution code in R 
## A
reduced_df = subset(df, continent != '')
reduced_df$year <- strftime(reduced_df$date, "%Y")
reduced_df$month <- strftime(reduced_df$date, "%m")
agg_reduced_df_a <- aggregate(new_cases_per_million ~ month + year + location, reduced_df, FUN = sum)
agg_reduced_df_a$date <- with(agg_reduced_df_a, paste(year, month,sep="-"))
new_cases_per_million_boxplot <- agg_reduced_df_a %>% ggplot(aes(x= month, y= new_cases_per_million)) +
  geom_boxplot(outlier.colour = "green") + facet_wrap(~year, ncol=3) +
  labs(title = "Number of Total Cases Per Million for Each Month",
       subtitle = "Data Plotted by Year", y= "Total Cases", x= "Month")
new_cases_per_million_boxplot
## B
# For New Deaths:
agg_reduced_df_death <- aggregate(new_deaths ~ month + year + location, reduced_df, FUN = sum)
agg_reduced_df_death$date <- with(agg_reduced_df_death, paste(year, month,sep="-"))
new_deaths_boxplot <- agg_reduced_df_death %>% ggplot(aes(x= month, y= new_deaths)) +
  geom_boxplot(outlier.colour = "orange") + facet_wrap(~year, ncol = 3) +
  labs(title = "Number of New Deaths", subtitle = "Data Plotted by Year",
       y= "New Deaths", x= "Month")
new_deaths_boxplot
# For New Vaccinations:
agg_reduced_df_vaccinations <- aggregate(new_vaccinations ~ month + year + location, reduced_df, FUN = sum)
agg_reduced_df_vaccinations$date <- with(agg_reduced_df_vaccinations, paste(year, month,sep="-"))
new_vaccinations_boxplot <- agg_reduced_df_vaccinations %>% ggplot(aes(x= month, y= new_vaccinations)) +
  geom_boxplot(outlier.colour = "red") + facet_wrap(~year, ncol = 3) +
  labs(title = "Number of New Vaccinations", subtitle = "Data Plotted by Year",
       y= "New Vaccinations", x= "Month")
new_vaccinations_boxplot
```
[Solution text - description of analysis and results]

6. [Solution text - explanations] 
```{r} 
# Solution code in R 
df_for6 <- df %>% group_by(location) %>% mutate(R_cases = new_cases_smoothed /
                                         lag(new_cases_smoothed, n = 7))
df_for6$R_cases[is.infinite(df_for6$R_cases)] <- NA
df_for6$R_cases
```
[Solution text - description of analysis and results]

7. [Solution text - explanations] 
```{r} 
#data preparation#
mapdata_deaths<-df[c("location","total_deaths_per_million")]%>%group_by(location)%>%slice(which.max(total_deaths_per_million))
mapdata_vaccinations<-df[c("location","total_vaccinations_per_hundred")]%>%group_by(location)%>%slice(which.max(total_vaccinations_per_hundred))
mapdata_mortality<-df[c("location","excess_mortality_cumulative_per_million")]%>%group_by(location)%>%slice(which.max(excess_mortality_cumulative_per_million))
#Creating the maps#
map_world_deaths<-joinCountryData2Map(mapdata_deaths,joinCode = "NAME",nameJoinColumn = "location")
colourpalette<-brewer.pal(8,'Accent')
mapCountryData(map_world_deaths,nameColumnToPlot = 'total_deaths_per_million',catMethod = 'fixedwidth',colourPalette=colourpalette,numCats = 200,missingCountryCol = "white")

map_world_vaccinations<-joinCountryData2Map(mapdata_vaccinations,joinCode = "NAME",nameJoinColumn = "location")
mapCountryData(map_world_vaccinations,nameColumnToPlot = 'total_vaccinations_per_hundred',catMethod = 'fixedwidth',colourPalette=colourpalette,numCats = 200,missingCountryCol = "white")

map_world_mortality<-joinCountryData2Map(mapdata_mortality,joinCode = "NAME",nameJoinColumn = "location")
mapCountryData(map_world_mortality,nameColumnToPlot = 'excess_mortality_cumulative_per_million',catMethod = 'fixedwidth',colourPalette=colourpalette,numCats = 200,missingCountryCol = "white")

```
[Solution text - description of analysis and results]

8. [Solution text - explanations] 
```{r}

"Do we see a decrease in the risk over time? can you suggest explanations for the observed trends?"

```
[Solution text - description of analysis and results]

9. [Solution text - explanations] 
```{r} 
"a"
#data preparation#

df_q9 <-df %>%group_by(location)%>% mutate(death_rate = total_deaths/total_cases)
df_q9<-subset(df_q9, date >= as.Date('2021-01-01'))
df_q9 <- subset(df_q9, location %in% c('Africa', 'Asia', 'Europe', 'North America', 'Oceania', 'South America', 'World'))

# create the plots#
ggplot(df_q9, aes(x=date, y=death_rate, color=location)) + geom_line()+labs(title = 'death_rate time line',x="date", y="death rate")
"b"
ggplot(df_q9, aes(x=date, y=total_vaccinations_per_hundred, color=location)) + geom_line()


```
[Solution text - description of analysis and results]

10. [Solution text - explanations] 
```{r}
#a
#data preparation#
current$excess_mortality = abs(current$total_deaths_per_million - current$excess_mortality_cumulative_per_million)
current_10f<-filter(current,excess_mortality>=2000)

# create the plot#
ggplot(current,aes(x= total_deaths_per_million,y=excess_mortality_cumulative_per_million))+geom_point(size = 0.5)+
#create the Equations mentioned in the question
geom_point(data =current_10f, color = "blue",size = 0.5)+geom_abline(intercept=0, slope = 1, color = "green")+geom_abline(intercept=2000, slope = 1, color = "pink")+geom_abline(intercept=-2000, slope = 1, color = "orange")+
#Arrange the text
geom_text(data = current_10f,hjust= 0,nudge_x = 0.05,size =2,aes(label = location),color = "red")+  labs(title = " deaths and excess mortality per million")


#b
#Pick three countries and create the data
chosen_countries <- c("Serbia","Armenia","Bulgaria")
df_q10 <- filter(df,location%in%chosen_countries)
df_q10 <-select(df_q10,c(location,date,total_deaths_per_million,excess_mortality_cumulative_per_million))
#create the plot
ggplot(df_q10,aes(x=date))+geom_line(aes(y = total_deaths_per_million, col = location)) +
  geom_point(aes( y = excess_mortality_cumulative_per_million, col = location), shape = 21)
```
[Solution text - description of analysis and results]

11. [Solution text - explanations] 
```{r} 
# Solution code in R 

```
[Solution text - description of analysis and results]

<br/><br/>  



